{% extends 'UMAP_App/Admin/Admin_Sidebar.html' %}
{% load static %}

{% block content %}
      {% if messages %}
      <div class="mt-4">
          {% for message in messages %}
          <div class="{% if message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %} p-3 rounded-md mb-2">
              {{ message }}
          </div>
          {% endfor %}
      </div>
      {% endif %}

      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-semibold text-white">Add New Floor</h2>
          <p class="text-sm text-gray-400">Create a new floor and upload its 3D model</p>
        </div>
        <div>
          <a href="{% url 'admin_floor_list' %}" class="px-4 py-2 bg-slate-700/50 text-gray-300 rounded-md hover:bg-slate-700/70">
            <i class="fas fa-arrow-left mr-2"></i>Back to List
          </a>
        </div>
      </div>

      <div class="mt-8 bg-slate-800/50 p-6 rounded-2xl shadow-sm backdrop-blur-sm">
        <h3 class="text-lg font-medium mb-4 text-white">Add / Edit Floor</h3>
        <form method="POST" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {% csrf_token %}
          <input type="hidden" name="floor_id" value="{{ form.instance.id|default:'' }}">
          <div>
            <label class="text-sm text-gray-300">Floor Name</label>
            {{ form.name }}
            {% if form.name.errors %}
            <p class="text-red-300 text-xs mt-1">{{ form.name.errors.0 }}</p>
            {% endif %}
          </div>
          <div>
            <label class="text-sm text-gray-600">Building</label>
            {{ form.building }}
            {% if form.building.errors %}
            <p class="text-red-500 text-xs mt-1">{{ form.building.errors.0 }}</p>
            {% endif %}
          </div>
          
          <!-- 3D Model Upload Field -->
          <div class="col-span-full">
            <label class="text-sm text-gray-300">Floor 3D Model (.glb)</label>
            <div class="mt-1 flex items-center gap-4">
              {{ form.model_file }}
              {% if form.instance.model_url %}
              <a href="{{ form.instance.model_url }}" 
                 class="text-blue-400 hover:text-blue-300 text-sm"
                 target="_blank">
                <i class="fas fa-external-link-alt mr-1"></i>
                Current Model
              </a>
              {% endif %}
            </div>
            {% if form.model_file.errors %}
            <p class="text-red-300 text-xs mt-1">{{ form.model_file.errors.0 }}</p>
            {% endif %}
            <script>
              document.getElementById('id_model_file').addEventListener('change', handleModelUpload);
            </script>
          </div>

          <!-- CSV Upload for Room Coordinates -->
          <div class="col-span-full">
            <label class="text-sm text-gray-300">Room Coordinates</label>
            <p class="text-xs text-gray-400 mt-1 mb-2">Room coordinates are automatically imported from Room_coords.csv. Edit room coordinates below if needed.</p>
            <button type="button" id="edit-coords-btn" 
                    class="mt-2 px-3 py-1 bg-blue-600/20 text-blue-400 rounded-md hover:bg-blue-600/30 text-sm">
              <i class="fas fa-edit mr-1"></i>Edit Room Coordinates
            </button>
            <div id="coords-status" class="mt-2 text-sm hidden"></div>
          </div>

          <!-- Floor Plan SVG Upload Field -->
          <div class="col-span-full">
            <label class="text-sm text-gray-300">Floor Plan SVG (.svg)</label>
            <p class="text-xs text-gray-400 mt-1 mb-2">Upload an SVG floor plan for this floor (e.g., HPSB1.svg, HPSB2.svg, etc.)</p>
            <div class="mt-1 flex items-center gap-4">
              {{ form.floorplan_svg }}
              {% if form.instance.floorplan_url %}
              <a href="{{ form.instance.floorplan_url }}" 
                 class="text-blue-400 hover:text-blue-300 text-sm"
                 target="_blank">
                <i class="fas fa-external-link-alt mr-1"></i>
                Current Floor Plan
              </a>
              {% endif %}
            </div>
            {% if form.floorplan_svg.errors %}
            <p class="text-red-300 text-xs mt-1">{{ form.floorplan_svg.errors.0 }}</p>
            {% endif %}
            
            <!-- SVG Room Auto-Creation -->
            <div class="mt-3 p-4 bg-slate-700/30 rounded-lg border border-slate-600">
              <div class="flex items-center gap-2 mb-3">
                <input type="checkbox" id="auto_create_rooms" name="auto_create_rooms" value="on" checked
                       class="rounded border-gray-600 text-indigo-600">
                <label for="auto_create_rooms" class="text-sm text-gray-300">
                  Automatically extract and create rooms from SVG (enabled by default)
                </label>
              </div>
              
              <p class="text-xs text-gray-400 mb-3">
                When you save with this option enabled, the system will automatically read the SVG file 
                to discover room IDs and create Room records. Existing rooms will not be duplicated.
              </p>
              
              <button type="button" id="preview-svg-btn" 
                      class="px-3 py-1 bg-blue-600/20 text-blue-400 rounded-md hover:bg-blue-600/30 text-sm">
                <i class="fas fa-eye mr-1"></i>Preview Rooms from SVG
              </button>
              
              <div id="svg-preview" class="mt-3 hidden">
                <div class="bg-slate-800/50 rounded-md p-3 max-h-64 overflow-y-auto">
                  <p class="text-xs text-gray-400 mb-2">Rooms detected in SVG:</p>
                  <div id="rooms-list" class="space-y-1"></div>
                </div>
              </div>
              
              <div id="svg-status" class="mt-2 text-sm hidden"></div>
            </div>
          </div>
          
          <div class="col-span-full flex gap-3 mt-2">
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save</button>
            <button type="reset" class="px-4 py-2 border rounded-md hover:bg-gray-50">Reset</button>
            {% if form.instance.id %}
            <button type="button" 
                    onclick="deleteItem('floor', {{ form.instance.id }})" 
                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 ml-auto">
              Delete
            </button>
            {% endif %}
          </div>
        </form>
      </div>

      <!-- Three.js and GLTFLoader -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
      
      <script>
        let scene, camera, renderer, controls, model;
        let animationFrameId;
        const container = document.getElementById('model-viewer');

        function initThreeJs() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);

            // Camera setup
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            camera = new THREE.PerspectiveCamera(
                50,
                width / height,
                0.1,
                1000
            );
            camera.position.set(15, 15, 15); // Fixed camera position
            camera.lookAt(0, 0, 0); // Look at center

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0x1a1a1a, 1);
            
            // Clear container and add renderer
            container.innerHTML = '';
            container.appendChild(renderer.domElement);

            // Controls setup
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 2;
            controls.maxDistance = 20;
            controls.target.set(0, 0, 0);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(5, 10, 5);
            scene.add(directionalLight);

            // Grid helper
            const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x222222);
            scene.add(gridHelper);

            // Animation loop
            function animate() {
                animationFrameId = requestAnimationFrame(animate);
                controls.update();
                
                if (model && document.getElementById('autoRotate').checked) {
                    model.rotation.y += 0.01;
                }
                
                renderer.render(scene, camera);
            }
            animate();

            // Window resize handler
            window.addEventListener('resize', onWindowResize, false);
            
            // Initialize controls
            setupControls();
        }

        function onWindowResize() {
            if (!container) return;
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        function setupControls() {
            // Reset camera button
            const resetBtn = document.getElementById('resetCamera');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    camera.position.set(10, 10, 10);
                    controls.target.set(0, 0, 0);
                    controls.reset();
                });
            }

            // Auto-rotate toggle
            const autoRotateCheckbox = document.getElementById('autoRotate');
            if (autoRotateCheckbox) {
                autoRotateCheckbox.addEventListener('change', (e) => {
                    controls.autoRotate = e.target.checked;
                });
            }

            // Wireframe toggle
            const wireframeCheckbox = document.getElementById('wireframe');
            if (wireframeCheckbox) {
                wireframeCheckbox.addEventListener('change', (e) => {
                    if (model) {
                        model.traverse((child) => {
                            if (child.isMesh) {
                                child.material.wireframe = e.target.checked;
                            }
                        });
                    }
                });
            }
        }

        function loadModel(url) {
            const loader = new THREE.GLTFLoader();
            
            // Clear existing model
            if (model) {
                scene.remove(model);
            }

            loader.load(
                url,
                function (gltf) {
                    model = gltf.scene;
                    
                    // Get bounding box of the model
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    
                    // Center the model at origin so fixed camera points at it
                    model.position.sub(center);
                    
                    // Calculate scale to fit in viewable area
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 8 / maxDim;
                    model.scale.setScalar(scale);
                    
                    scene.add(model);
                    
                    // Fixed camera always points at origin (where model is centered)
                    camera.position.set(15, 15, 15);
                    camera.lookAt(0, 0, 0);
                    
                    console.log('Model loaded successfully - Size:', size);
                },
                function (xhr) {
                    const percentComplete = (xhr.loaded / xhr.total * 100);
                    console.log(percentComplete + '% loaded');
                },
                function (error) {
                    console.error('Error loading model:', error);
                    console.error('Error stack:', error.stack);
                }
            );
        }

        function handleModelUpload(event) {
            const file = event.target.files[0];
            if (file) {
                console.log('File selected:', file.name);
                const url = URL.createObjectURL(file);
                loadModel(url);
            }
        }

        // Wait for DOM to be ready before initializing
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initThreeJs();
                
                // Set up file input listener
                const fileInput = document.getElementById('id_model_file');
                if (fileInput) {
                    fileInput.addEventListener('change', handleModelUpload);
                }
                
                // Load existing model if available
                {% if form.instance.model_url %}
                loadModel("{{ form.instance.model_url }}");
                {% endif %}
            });
        } else {
            initThreeJs();
            
            // Set up file input listener
            const fileInput = document.getElementById('id_model_file');
            if (fileInput) {
                fileInput.addEventListener('change', handleModelUpload);
            }
            
            // Load existing model if available
            {% if form.instance.model_url %}
            loadModel("{{ form.instance.model_url }}");
            {% endif %}
        }

        // Cookie and delete functionality
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function deleteItem(modelName, itemId) {
            if (!confirm('Are you sure you want to delete this floor? All associated rooms will also be deleted.')) return;
            
            try {
                const response = await fetch(`/api/delete/${modelName}/${itemId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    window.location.href = "{% url 'admin_floor_list' %}";
                } else {
                    const data = await response.json();
                    alert(data.message || 'Error deleting floor');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting floor');
            }
        }

        // CSV Import Functions - REMOVED (using Room_coords.csv instead)
        
        // Edit Room Coordinates Function
        function openEditCoordinatesModal() {
            const floorId = {{ form.instance.id|default:"null" }};
            
            if (!floorId) {
                alert('Please save the floor first before editing coordinates');
                return;
            }
            
            const modalHTML = `
                <div id="coords-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div class="bg-slate-800 rounded-lg p-6 max-w-4xl max-h-96 overflow-y-auto border border-gray-600">
                        <h3 class="text-lg font-bold text-white mb-4">Edit Room Coordinates</h3>
                        <div id="rooms-coords-table" class="text-xs text-gray-300">
                            <p class="text-center text-gray-400">Loading rooms...</p>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="saveCoordinatesChanges()" 
                                    class="px-4 py-2 bg-green-600/20 text-green-400 rounded-md hover:bg-green-600/30">
                                Save Changes
                            </button>
                            <button onclick="document.getElementById('coords-modal').remove()" 
                                    class="px-4 py-2 bg-gray-600/20 text-gray-400 rounded-md hover:bg-gray-600/30">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            loadRoomCoordinatesData(floorId);
        }
        
        function loadRoomCoordinatesData(floorId) {
            // Fetch rooms for this floor
            fetch(`/api/floor-rooms/${floorId}/`)
                .then(response => response.json())
                .then(data => {
                    const tableContainer = document.getElementById('rooms-coords-table');
                    
                    if (!data.rooms || data.rooms.length === 0) {
                        tableContainer.innerHTML = '<p class="text-yellow-400">No rooms found for this floor</p>';
                        return;
                    }
                    
                    let html = `
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-gray-300">
                                <thead class="text-xs text-gray-400 border-b border-gray-600">
                                    <tr>
                                        <th class="px-2 py-1 text-left">Room #</th>
                                        <th class="px-2 py-1 text-left">Name</th>
                                        <th class="px-2 py-1 text-left">X</th>
                                        <th class="px-2 py-1 text-left">Y</th>
                                        <th class="px-2 py-1 text-left">Z</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.rooms.forEach(room => {
                        const coords = room.coordinates || {};
                        html += `
                            <tr class="border-b border-gray-700 hover:bg-slate-700/30" data-room-id="${room.id}">
                                <td class="px-2 py-1">${room.number}</td>
                                <td class="px-2 py-1">${room.name}</td>
                                <td class="px-2 py-1"><input type="number" step="0.01" value="${coords.x || 0}" class="coord-x bg-slate-700/50 border border-gray-600 rounded px-1 w-20" /></td>
                                <td class="px-2 py-1"><input type="number" step="0.01" value="${coords.y || 0}" class="coord-y bg-slate-700/50 border border-gray-600 rounded px-1 w-20" /></td>
                                <td class="px-2 py-1"><input type="number" step="0.01" value="${coords.z || 0}" class="coord-z bg-slate-700/50 border border-gray-600 rounded px-1 w-20" /></td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    tableContainer.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading room coordinates:', error);
                    document.getElementById('rooms-coords-table').innerHTML = 
                        '<p class="text-red-400">Error loading rooms. Please refresh and try again.</p>';
                });
        }
        
        function saveCoordinatesChanges() {
            const floorId = {{ form.instance.id|default:"null" }};
            const updates = [];
            
            // Collect all coordinate changes
            document.querySelectorAll('tr[data-room-id]').forEach(row => {
                const roomId = row.getAttribute('data-room-id');
                const x = parseFloat(row.querySelector('.coord-x').value);
                const y = parseFloat(row.querySelector('.coord-y').value);
                const z = parseFloat(row.querySelector('.coord-z').value);
                
                updates.push({
                    room_id: roomId,
                    coordinates: { x, y, z }
                });
            });
            
            // Send updates to backend
            fetch(`/api/update-room-coordinates/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ updates })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Coordinates updated successfully');
                    document.getElementById('coords-modal').remove();
                } else {
                    alert('Error updating coordinates: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving coordinates');
            });
        }

        // SVG Preview Functions
        function previewSVGRooms() {
            const fileInput = document.getElementById('id_floorplan_svg');
            const file = fileInput ? fileInput.files[0] : null;
            
            if (!file) {
                showSVGMessage('No SVG file selected. Please select a file first.', 'error');
                return;
            }
            
            // Read and parse SVG file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const svgContent = e.target.result;
                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
                    
                    if (svgDoc.parseError) {
                        showSVGMessage('Invalid SVG file: ' + svgDoc.parseError.reason, 'error');
                        return;
                    }
                    
                    // Extract all elements with IDs (potential rooms)
                    const elements = svgDoc.querySelectorAll('[id]');
                    const rooms = [];
                    const excludedPatterns = ['hpsb', 'elevator', 'wall', 'door', 'stair', 'bg', 'background', 'frame', 'outline', 'grid'];
                    
                    elements.forEach(el => {
                        const id = el.getAttribute('id');
                        if (!id) return;
                        
                        // Skip structural elements
                        const isStructural = excludedPatterns.some(pattern => 
                            id.toLowerCase().includes(pattern)
                        );
                        
                        if (!isStructural && id.match(/^\d+$/)) {  // Only numeric IDs (room numbers)
                            rooms.push({
                                id: id,
                                tag: el.tagName
                            });
                        }
                    });
                    
                    if (rooms.length === 0) {
                        showSVGMessage('No rooms found in SVG. Numeric element IDs expected.', 'warning');
                        return;
                    }
                    
                    displayRoomsList(rooms);
                    showSVGMessage(`Found ${rooms.length} rooms in SVG file.`, 'success');
                    
                } catch (error) {
                    showSVGMessage('Error parsing SVG: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        function displayRoomsList(rooms) {
            const roomsList = document.getElementById('rooms-list');
            const preview = document.getElementById('svg-preview');
            
            roomsList.innerHTML = rooms.map((room, idx) => `
                <div class="text-xs text-gray-300 p-2 bg-slate-700/50 rounded flex justify-between">
                    <span>${room.id}</span>
                    <span class="text-gray-500">(&lt;${room.tag}&gt;)</span>
                </div>
            `).join('');
            
            preview.classList.remove('hidden');
        }
        
        function showSVGMessage(message, type) {
            const element = document.getElementById('svg-status');
            element.classList.remove('hidden');
            element.className = `mt-2 text-sm ${
                type === 'error' ? 'text-red-400' : 
                type === 'warning' ? 'text-yellow-400' : 
                'text-green-400'
            }`;
            element.textContent = message;
            
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }
        
        // Setup event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const previewBtn = document.getElementById('preview-svg-btn');
            if (previewBtn) {
                previewBtn.addEventListener('click', previewSVGRooms);
            }
            
            const editCoordsBtn = document.getElementById('edit-coords-btn');
            if (editCoordsBtn) {
                editCoordsBtn.addEventListener('click', openEditCoordinatesModal);
            }
            
            // Log checkbox state when form is submitted
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function() {
                    const checkbox = document.getElementById('auto_create_rooms');
                    const svgFile = document.querySelector('input[name="floorplan_svg"]');
                    console.log('Form submitted with:');
                    console.log('  - auto_create_rooms checked:', checkbox.checked);
                    console.log('  - auto_create_rooms in form data:', checkbox.checked ? 'on' : 'not present');
                    console.log('  - SVG file selected:', svgFile.files.length > 0 ? svgFile.files[0].name : 'none');
                });
            }
        });
      </script>
{% endblock %}
    
